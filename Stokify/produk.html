<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Produk - Stokify</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h2>Daftar Produk</h2>

  <input type="text" id="search" placeholder="Cari produk..." />

  <div id="productList"></div>

  <p><a href="checkout.html">Lihat Keranjang & Checkout</a></p>
  <p><a href="index.html">Logout</a></p>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://tfvzsriecpzvrnzlvwww.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmdnpzcmllY3B6dnJuemx2d3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTc5NzMsImV4cCI6MjA2NTEzMzk3M30.z1OHvDg0kkgyzmaW_BIho4tTHCXfFXSSH-KjYrPosOg'
    );

    const productList = document.getElementById('productList');
    const searchInput = document.getElementById('search');

    let products = [];

    // Ambil produk dari Supabase
    async function fetchProducts() {
      const { data, error } = await supabase.from('products').select('*').order('name', { ascending: true });
      if (error) {
        productList.innerHTML = 'Gagal memuat produk: ' + error.message;
        return;
      }
      products = data;
      renderProducts(products);
    }

    // Render produk ke halaman
    function renderProducts(list) {
      if (list.length === 0) {
        productList.innerHTML = '<p>Tidak ada produk ditemukan.</p>';
        return;
      }
      productList.innerHTML = list
        .map(p => `
          <div class="product-item">
            <img src="${p.image_url || 'placeholder.png'}" alt="${p.name}" width="120" />
            <h3>${p.name}</h3>
            <p>Harga: Rp${p.price.toLocaleString()}</p>
            <button data-id="${p.id}">Beli</button>
          </div>
        `).join('');
    }

    // Tambahkan event listener untuk beli produk
    productList.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        const id = e.target.dataset.id;
        const product = products.find(p => p.id == id);
        if (!product) return;

        // Simpan produk ke localStorage sebagai keranjang
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        const existing = cart.find(item => item.id === product.id);
        if (existing) {
          existing.qty += 1;
        } else {
          cart.push({ id: product.id, name: product.name, price: product.price, qty: 1 });
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        alert(`Produk "${product.name}" ditambahkan ke keranjang.`);
      }
    });

    // Filter produk berdasarkan pencarian
    searchInput.addEventListener('input', () => {
      const keyword = searchInput.value.toLowerCase();
      const filtered = products.filter(p => p.name.toLowerCase().includes(keyword));
      renderProducts(filtered);
    });

    fetchProducts();
  </script>
</body>
</html>
